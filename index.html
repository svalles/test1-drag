<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>X86 Paging Simulator</title>
    <style>
        /* Estilos anteriores... */
        .entry {
            cursor: pointer;
            padding: 3px;
            margin: 2px;
            background: #505050;
        }
        
        .entry:hover {
            background: #606060;
        }
        
        .pagina {
            background: #4a4a4a;
            border: 1px solid #8bc34a;
            width: 120px;
            height: 120px;
        }
        
        .arrow {
            stroke: #ff5722;
            stroke-width: 2;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <!-- Contenido anterior... -->
            <div class="controls">
                <button onclick="setCR3()">Establecer CR3</button>
                <button onclick="createPageTable()">Nueva Page Table</button>
                <button onclick="createPage()">Nueva Página Física</button>
            </div>
        </div>

        <div class="simulation-area" id="simulation">
            <div class="register" id="cr3-display">CR3: 0x00000000</div>
            <svg id="arrows" width="100%" height="100%"></svg>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <script>
        let currentCR3 = 0x00000000;
        let pageTables = new Map(); // key: address, value: element
        let pages = new Map();      // key: address, value: element

        function setCR3() {
            const newCR3 = prompt("Ingrese nuevo valor para CR3 (hex):", "0x00000000");
            if(newCR3) {
                currentCR3 = parseInt(newCR3, 16);
                document.getElementById('cr3-display').textContent = `CR3: 0x${currentCR3.toString(16).padStart(8, '0')}`;
                createPageDirectory();
            }
        }

        function createPageDirectory() {
            const existing = document.getElementById('page-directory');
            if(existing) existing.remove();

            const dir = document.createElement('div');
            dir.className = 'memory-block';
            dir.id = 'page-directory';
            dir.style.left = "50px";
            dir.style.top = "100px";
            dir.innerHTML = `<h3>Page Directory (CR3: 0x${currentCR3.toString(16).padStart(8, '0')})</h3>`;

            for(let i = 0; i < 4; i++) {
                const entry = document.createElement('div');
                entry.className = 'entry';
                entry.textContent = `PDE ${i}: 0x00000000`;
                entry.dataset.index = i;
                entry.onclick = () => editDirectoryEntry(i);
                dir.appendChild(entry);
            }
            
            simulation.appendChild(dir);
            makeDraggable(dir);
        }

        function createPageTable(address = 0x1000) {
            const table = document.createElement('div');
            table.className = 'memory-block';
            table.style.left = "300px";
            table.style.top = "200px";
            table.innerHTML = `<h3>Page Table (0x${address.toString(16).padStart(8, '0')})</h3>`;

            for(let i = 0; i < 4; i++) {
                const entry = document.createElement('div');
                entry.className = 'entry';
                entry.textContent = `PTE ${i}: 0x00000000`;
                entry.dataset.index = i;
                entry.onclick = () => editTableEntry(table, i);
                table.appendChild(entry);
            }
            
            simulation.appendChild(table);
            pageTables.set(address, table);
            makeDraggable(table);
            return table;
        }

        function createPage(address = 0x2000) {
            const page = document.createElement('div');
            page.className = 'memory-block pagina';
            page.textContent = `Página Física\n0x${address.toString(16).padStart(8, '0')`;
            page.style.left = "500px";
            page.style.top = "300px";
            
            simulation.appendChild(page);
            pages.set(address, page);
            makeDraggable(page);
            updateArrows();
            return page;
        }

        function editDirectoryEntry(index) {
            const newVal = prompt(`Ingrese valor para PDE ${index} (dirección de Page Table):`, "0x00001000");
            if(newVal) {
                const address = parseInt(newVal, 16);
                const entry = document.querySelector(`#page-directory .entry[data-index="${index}"]`);
                entry.textContent = `PDE ${index}: 0x${address.toString(16).padStart(8, '0')}`;
                
                if(!pageTables.has(address)) {
                    createPageTable(address);
                }
                updateArrows();
            }
        }

        function editTableEntry(table, index) {
            const newVal = prompt(`Ingrese valor para PTE ${index} (dirección de Página Física):`, "0x00002000");
            if(newVal) {
                const address = parseInt(newVal, 16);
                const entry = table.querySelector(`.entry[data-index="${index}"]`);
                entry.textContent = `PTE ${index}: 0x${address.toString(16).padStart(8, '0')}`;
                
                if(!pages.has(address)) {
                    createPage(address);
                }
                updateArrows();
            }
        }

        function updateArrows() {
            const svg = document.getElementById('arrows');
            svg.innerHTML = '';
            
            // Dibujar flechas desde CR3 al Page Directory
            const cr3 = document.getElementById('cr3-display');
            const dir = document.getElementById('page-directory');
            drawArrow(cr3, dir, 'CR3');
            
            // Dibujar flechas desde PDEs a Page Tables
            document.querySelectorAll('#page-directory .entry').forEach(entry => {
                const address = parseInt(entry.textContent.split('0x')[1], 16);
                if(pageTables.has(address)) {
                    drawArrow(entry, pageTables.get(address), 'PDE');
                }
            });
            
            // Dibujar flechas desde PTEs a Páginas
            pageTables.forEach(table => {
                table.querySelectorAll('.entry').forEach(entry => {
                    const address = parseInt(entry.textContent.split('0x')[1], 16);
                    if(pages.has(address)) {
                        drawArrow(entry, pages.get(address), 'PTE');
                    }
                });
            });
        }

        function drawArrow(from, to, type) {
            const svg = document.getElementById('arrows');
            const fromRect = from.getBoundingClientRect();
            const toRect = to.getBoundingClientRect();
            const svgRect = svg.getBoundingClientRect();

            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', fromRect.left + fromRect.width/2 - svgRect.left);
            line.setAttribute('y1', fromRect.top + fromRect.height - svgRect.top);
            line.setAttribute('x2', toRect.left + toRect.width/2 - svgRect.left);
            line.setAttribute('y2', toRect.top - svgRect.top);
            line.setAttribute('class', 'arrow');
            line.dataset.type = type;
            svg.appendChild(line);
        }

        function makeDraggable(element) {
            interact(element).draggable({
                listeners: {
                    move(event) {
                        const x = (parseFloat(event.target.getAttribute('data-x')) || 0) + event.dx;
                        const y = (parseFloat(event.target.getAttribute('data-y')) || 0) + event.dy;

                        event.target.style.transform = `translate(${x}px, ${y}px)`;
                        event.target.setAttribute('data-x', x);
                        event.target.setAttribute('data-y', y);
                        
                        updateArrows();
                    }
                }
            });
        }

        // Inicialización
        createPageDirectory();
        createPageTable(0x1000);
        createPage(0x2000);
    </script>
</body>
</html>
